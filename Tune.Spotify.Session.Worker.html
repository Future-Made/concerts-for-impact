<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.22.2">
    <meta name="project" content="tune v0.1.0">
    <title>Tune.Spotify.Session.Worker — tune v0.1.0</title>
    <link rel="stylesheet" href="dist/elixir-d678dad126d82ddc061f.css" />
    <script src="dist/sidebar_items-8e887f5965.js"></script>
      <script src="docs_config.js"></script>
    <script async src="dist/app-0103364119015b97e56c.js"></script>
  </head>
  <body data-type="modules">
    <script>try { if(localStorage.getItem('night-mode') === 'true') document.body.className += ' night-mode'; } catch (e) { }</script>
<div class="main">

<button class="sidebar-button sidebar-toggle">
  <span class="icon-menu" title="Collapse/expand sidebar"></span>
</button>

<section class="sidebar">
  <form class="sidebar-search" action="search.html">
    <button type="submit" class="search-button">
      <span class="icon-search" aria-hidden="true"></span>
    </button>
    <button type="button" tabindex="-1" class="search-close-button">
      <span class="icon-cross" title="Cancel search"></span>
    </button>
    <label class="search-label">
      <input name="q" type="text" id="search-list" class="search-input" placeholder="Search..." aria-label="Search" autocomplete="off" />
    </label>
  </form>

  <div class="autocomplete">
    <div class="autocomplete-results">
    </div>
  </div>

  <div class="sidebar-header">
    <div class="sidebar-projectDetails">
      <a href="readme.html" class="sidebar-projectName">
tune      </a>
      <h2 class="sidebar-projectVersion">
        v0.1.0
      </h2>
    </div>
  </div>

  <ul class="sidebar-listNav">
    <li><a id="extras-list" href="#full-list">Pages</a></li>

      <li><a id="modules-list" href="#full-list">Modules</a></li>

  </ul>
  <div class="gradient"></div>
  <ul id="full-list" class="sidebar-fullList"></ul>
</section>

<section class="content">
  <div class="content-outer">
    <div id="content" class="content-inner">

      <h1>
        <small class="app-vsn">tune v0.1.0</small>
Tune.Spotify.Session.Worker      </h1>


        <section id="moduledoc">
<p>This module implements a worker mapped to a user session, wrapping
interaction with the Spotify API.</p><h2 id="module-general-structure" class="section-heading">
  <a href="#module-general-structure" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  General structure
</h2>
<p>The worker implements the <a href="Tune.Spotify.Session.html"><code class="inline">Tune.Spotify.Session</code></a> behaviour for its public API
and uses <a href="https://hexdocs.pm/gen_state_machine/GenStateMachine.html"><code class="inline">GenStateMachine</code></a> to model its lifecycle.</p><p>If you're not familiar with the <code class="inline">gen_statem</code> behaviour (which powers
<a href="https://hexdocs.pm/gen_state_machine/GenStateMachine.html"><code class="inline">GenStateMachine</code></a>), it's beneficial to read
<a href="http://erlang.org/doc/design_principles/statem.html">http://erlang.org/doc/design_principles/statem.html</a> before proceeding
further.</p><p>The state machine uses the <code class="inline">handle_event_function</code> callback mode and has 3
states: <code class="inline">:not_authenticated</code>, <code class="inline">:authenticated</code> and <code class="inline">:expired</code>.</p><pre><code class="nohighlight makeup elixir"><span class="w">                              </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
                              </span><span class="err">│</span><span class="nc">Not</span><span class="w"> </span><span class="n">authenticated</span><span class="err">│</span><span class="w">
                              </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">
                                       </span><span class="err">│</span><span class="w">
                                       </span><span class="err">│</span><span class="w">
                                       </span><span class="err">▼</span><span class="w">
                             </span><span class="err">┌</span><span class="w"> </span><span class="err">─</span><span class="w"> </span><span class="err">─</span><span class="w"> </span><span class="err">─</span><span class="w"> </span><span class="err">─</span><span class="w"> </span><span class="err">─</span><span class="w"> </span><span class="err">─</span><span class="w"> </span><span class="err">─</span><span class="w"> </span><span class="err">─</span><span class="w"> </span><span class="err">─</span><span class="w">
                    </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="w">    </span><span class="nc">Authenticate</span><span class="w">   </span><span class="err">│</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
                    </span><span class="err">│</span><span class="w">        </span><span class="err">└</span><span class="w"> </span><span class="err">─</span><span class="w"> </span><span class="err">─</span><span class="w"> </span><span class="err">─</span><span class="w"> </span><span class="err">─</span><span class="w"> </span><span class="err">─</span><span class="w"> </span><span class="err">─</span><span class="w"> </span><span class="err">─</span><span class="w"> </span><span class="err">─</span><span class="w"> </span><span class="err">─</span><span class="w">          </span><span class="err">│</span><span class="w">
                    </span><span class="err">│</span><span class="w">                  </span><span class="err">│</span><span class="w">                  </span><span class="err">│</span><span class="w">
                </span><span class="nc">Success</span><span class="w">             </span><span class="nc">Token</span><span class="w">             </span><span class="nc">Invalid</span><span class="w">
                    </span><span class="err">│</span><span class="w">              </span><span class="n">expired</span><span class="w">             </span><span class="n">token</span><span class="w">
                    </span><span class="err">│</span><span class="w">                  </span><span class="err">│</span><span class="w">                  </span><span class="err">│</span><span class="w">
                    </span><span class="err">│</span><span class="w">                  </span><span class="err">│</span><span class="w">                  </span><span class="err">│</span><span class="w">
                    </span><span class="err">▼</span><span class="w">                  </span><span class="err">▼</span><span class="w">                  </span><span class="err">▼</span><span class="w">
             </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">    </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">    </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
             </span><span class="err">│</span><span class="nc">Authenticated</span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">   </span><span class="nc">Expired</span><span class="w">   </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="nc">Stop</span><span class="w">     </span><span class="err">│</span><span class="w">
             </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">    </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">    </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">
                    </span><span class="err">▲</span><span class="w">                  </span><span class="err">│</span><span class="w">                  </span><span class="err">▲</span><span class="w">
                    </span><span class="err">│</span><span class="w">              </span><span class="nc">Get</span><span class="w"> </span><span class="n">new</span><span class="w">                </span><span class="err">│</span><span class="w">
                </span><span class="nc">Success</span><span class="w">             </span><span class="n">token</span><span class="w">                 </span><span class="err">│</span><span class="w">
                    </span><span class="err">│</span><span class="w">    </span><span class="err">┌</span><span class="w"> </span><span class="err">─</span><span class="w"> </span><span class="err">─</span><span class="w"> </span><span class="err">─</span><span class="w"> </span><span class="err">─</span><span class="w">     </span><span class="err">│</span><span class="w">                  </span><span class="err">│</span><span class="w">
                    </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nc">Refresh</span><span class="w"> </span><span class="err">│</span><span class="err">◀</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">                  </span><span class="err">│</span><span class="w">
                         </span><span class="err">└</span><span class="w"> </span><span class="err">─</span><span class="w"> </span><span class="err">─</span><span class="w"> </span><span class="err">─</span><span class="w"> </span><span class="err">─</span><span class="w">                        </span><span class="err">│</span><span class="w">
                              </span><span class="err">│</span><span class="w">                           </span><span class="err">│</span><span class="w">
                              </span><span class="err">│</span><span class="w">          </span><span class="nc">Invalid</span><span class="w">          </span><span class="err">│</span><span class="w">
                              </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="n">refresh</span><span class="w"> </span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">
                                          </span><span class="n">token</span></code></pre><p>When the process starts, it tries to authenticate against the Spotify API
using the provided credentials. If successful, it enters the authenticated
state, where all API functions can be executed correctly.</p><p>If authentication fails because the authentication token has expired, the
process tries to get a new token using the refresh token supplied by the
Spotify API. This process effectively extends the duration of the session.</p><p>Any error that indicates that credentials are invalid causes the process to
stop. Any transient network error automatically triggers a delayed retry,
which guarantees that <em>eventually</em> the state machine reaches the
authenticated state.</p><h2 id="module-data-lifecycle" class="section-heading">
  <a href="#module-data-lifecycle" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Data lifecycle
</h2>
<p>Aside from acting as an API client for on-demand operations (e.g. search,
play/pause, etc.), the worker also regularly polls the Spotify API for
current player status and connected devices. Both pieces of information are
kept in the state machine data for fast read and corresponding events are
broadcasted when they change.</p><p>Automatic data fetch is performed after successful authentication (via an
<code class="inline">internal</code> event) and then scheduled via a <code class="inline">state_timeout</code> event. Once
handled, the scheduled event requeues itself via the same <code class="inline">state_timeout</code> events.</p><p>Usage of <code class="inline">state_timeout</code> events complies with the general state machine: if
at any point the machine enters the expired state, any queued <code class="inline">state_timeout</code>
event is automatically expired.</p><p>Automatic fetching will resume once the machine enters the authenticated state.</p><h2 id="module-subscriptions" class="section-heading">
  <a href="#module-subscriptions" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Subscriptions
</h2>
<p>Multiple processes are able to subscribe to the events keyed by the session id.</p><p>Broadcast and subscribe are implemented via <a href="https://hexdocs.pm/phoenix_pubsub/Phoenix.PubSub.html"><code class="inline">Phoenix.PubSub</code></a>, however the
Worker maintains its own set of monitored processes subscribed to the session
id.</p><p>Subscription tracking is necessary to implementing automatic termination of a
worker after a period of inactivity. Without that, the worker would
indefinitely poll the Spotify API, even when no client is interested into the
topic, until a crash error or a node reboot.</p><p>Every 30 seconds, the worker fires a named <code class="inline">timeout</code> event, checking if
there's any subscribed process. If not, it terminates. Subscribed processes
are monitored, so when they terminate, their exit is handled by the worker,
which removes them from its data.</p><p>Usage of named <code class="inline">timeout</code> events is necessary, as they're guaranteed to fire
irrespectively of state changes.</p>        </section>

        <section id="summary" class="details-list">
          <h1 class="section-heading">
            <a class="hover-link" href="#summary">
              <span class="icon-link" aria-hidden="true"></span>
              <span class="sr-only">Link to this section</span>
            </a>
            Summary
          </h1>
  <div class="summary-functions summary">
    <h2>
      <a href="#functions">Functions</a>
    </h2>
<div class="summary-row">
  <div class="summary-signature">
    <a href="#callback_mode/0">callback_mode()</a>
  </div>
</div>
<div class="summary-row">
  <div class="summary-signature">
    <a href="#child_spec/1">child_spec(arg)</a>
  </div>
    <div class="summary-synopsis"><p>Returns a specification to start this module under a supervisor.</p></div>
</div>
<div class="summary-row">
  <div class="summary-signature">
    <a href="#start_link/1">start_link(arg)</a>
  </div>
</div>
<div class="summary-row">
  <div class="summary-signature">
    <a href="#start_link/2">start_link(session_id, credentials)</a>
  </div>
</div>
  </div>
        </section>

        <section id="functions" class="details-list">
          <h1 class="section-heading">
            <a class="hover-link" href="#functions">
              <span class="icon-link" aria-hidden="true"></span>
              <span class="sr-only">Link to this section</span>
            </a>
Functions          </h1>
          <div class="functions-list">
<section class="detail" id="callback_mode/0">
  <div class="detail-header">
    <a href="#callback_mode/0" class="detail-link" title="Link to this function">
      <span class="icon-link" aria-hidden="true"></span>
      <span class="sr-only">Link to this function</span>
    </a>
    <h1 class="signature">callback_mode()</h1>
  </div>

  <section class="docstring">

  </section>
</section>
<section class="detail" id="child_spec/1">
  <div class="detail-header">
    <a href="#child_spec/1" class="detail-link" title="Link to this function">
      <span class="icon-link" aria-hidden="true"></span>
      <span class="sr-only">Link to this function</span>
    </a>
    <h1 class="signature">child_spec(arg)</h1>
  </div>

  <section class="docstring">

<p>Returns a specification to start this module under a supervisor.</p><p>See <a href="https://hexdocs.pm/elixir/Supervisor.html"><code class="inline">Supervisor</code></a> in Elixir v1.6+.</p>  </section>
</section>
<section class="detail" id="start_link/1">
  <div class="detail-header">
    <a href="#start_link/1" class="detail-link" title="Link to this function">
      <span class="icon-link" aria-hidden="true"></span>
      <span class="sr-only">Link to this function</span>
    </a>
    <h1 class="signature">start_link(arg)</h1>
  </div>

  <section class="docstring">
      <h2>Specs</h2>
      <div class="specs">
          <pre>start_link({<a href="Tune.Spotify.Session.html#t:id/0">Tune.Spotify.Session.id</a>(), <a href="Tune.Spotify.Session.html#t:credentials/0">Tune.Spotify.Session.credentials</a>()}) ::
  {:ok, <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">pid</a>()} | {:error, <a href="https://hexdocs.pm/elixir/typespecs.html#built-in-types">term</a>()}</pre>
      </div>

  </section>
</section>
<section class="detail" id="start_link/2">
  <div class="detail-header">
    <a href="#start_link/2" class="detail-link" title="Link to this function">
      <span class="icon-link" aria-hidden="true"></span>
      <span class="sr-only">Link to this function</span>
    </a>
    <h1 class="signature">start_link(session_id, credentials)</h1>
  </div>

  <section class="docstring">
      <h2>Specs</h2>
      <div class="specs">
          <pre>start_link(<a href="Tune.Spotify.Session.html#t:id/0">Tune.Spotify.Session.id</a>(), <a href="Tune.Spotify.Session.html#t:credentials/0">Tune.Spotify.Session.credentials</a>()) ::
  {:ok, <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">pid</a>()} | {:error, <a href="https://hexdocs.pm/elixir/typespecs.html#built-in-types">term</a>()}</pre>
      </div>

  </section>
</section>
          </div>
        </section>
      <footer class="footer">
        <p>
          <span class="line">
            Built using
            <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener">ExDoc</a> (v0.22.2),
          </span>
          <span class="line">
            designed by
            <a href="https://twitter.com/dignifiedquire" target="_blank" rel="noopener" title="@dignifiedquire">Friedel Ziegelmayer</a>.
          </span>
        </p>
        <p>
          <button class="line footer-button display-shortcuts-help">
            Display keyboard shortcuts
          </button>
          <button class="line footer-button night-mode-toggle">
            Toggle night mode
          </button>
          <button class="line footer-button display-quick-switch">
            Go to a HexDocs package
          </button>
          <button class="line footer-button tooltips-toggle">
            <span class="tooltips-option-disable">Disable tooltips</span>
            <span class="tooltips-option-enable">Enable tooltips</span>
          </button>
        </p>
      </footer>
    </div>
  </div>
</section>
</div>
<style>
  .content-inner code {
    font-family: IBM Plex Mono, Fira Code, Inconsolata,Menlo,Courier,monospace;
  }
</style>
  </body>
</html>
